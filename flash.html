<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flashcards Minka SDG</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }

    #app {
      max-width: 800px;
      margin: 0 auto;
    }

    img.card-image {
      max-width: 100%;
      max-height: 70vh;
      object-fit: contain; /* asegura que se vea completa */
      margin-bottom: 8px;
    }

    /* ðŸ“± Smartphone â†’ portrait */
    @media (max-width: 768px) {
      img.card-image {
        width: auto;
        height: 70vh;  /* prioriza altura */
      }
    }

    /* ðŸ’» Desktop â†’ landscape */
    @media (min-width: 769px) {
      img.card-image {
        width: 100%;   /* prioriza ancho */
        height: auto;
      }
    }

    .attribution {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 20px;
    }

    .card {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    button {
      margin: 8px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background: #007bff;
      color: white;
    }

    button:hover {
      background: #0056b3;
    }

    .export-import {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Flashcards Minka SDG</h1>
    <div id="screen"></div>
  </div>

  <script>
    const API_PATH = "https://api.minka-sdg.org/v1";
    let deck = [];
    let currentIndex = 0;
    let failedCards = [];
    let language = "es";
    let cardLimit = 25;

    // Pantalla inicial
    function showStartScreen() {
      document.getElementById("screen").innerHTML = `
        <div>
          <label>Idioma: 
            <select id="lang">
              <option value="es">EspaÃ±ol</option>
              <option value="ca">CatalÃ </option>
              <option value="en">English</option>
            </select>
          </label>
          <br><br>
          <label>Cantidad de tarjetas: 
            <select id="limit">
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </label>
          <br><br>
          <button onclick="startDeck()">Start</button>
          <div class="export-import">
            <button onclick="importDeck()">Importar falladas</button>
            <input type="file" id="importFile" style="display:none" />
          </div>
        </div>
      `;

      document.getElementById("lang").value = language;
      document.getElementById("limit").value = cardLimit;
    }

    async function startDeck() {
      language = document.getElementById("lang").value;
      cardLimit = parseInt(document.getElementById("limit").value);

      const response = await fetch(`${API_PATH}/observations?project_id=184`);
      const data = await response.json();
      const observations = data.results.slice(0, cardLimit);

      deck = await Promise.all(observations.map(loadCard));
      currentIndex = 0;
      failedCards = [];
      showCard();
    }

    async function loadCard(obs) {
      const photos = obs.photos.map(p => p.url.replace("/square.", "/original."));
      const attributions = obs.photos.map(p => p.attribution);
      const taxon = obs.taxon;

      // obtener nombre comÃºn en idioma
      let commonName = "";
      try {
        const res = await fetch(`${API_PATH}/taxa?taxon_id=${taxon.id}&locale=${language}`);
        const json = await res.json();
        commonName = json.results[0]?.preferred_common_name || "";
      } catch(e) {
        commonName = "";
      }

      return {
        id: obs.id,
        photos,
        attributions,
        scientific: taxon.name,
        common: commonName
      };
    }

    function showCard() {
      if (deck.length === 0) {
        showSummary();
        return;
      }

      const card = deck[currentIndex];
      document.getElementById("screen").innerHTML = `
        <div class="card">
          <img src="${card.photos[0]}" class="card-image" />
          <div class="attribution">${card.attributions[0] || ""}</div>
          <div><strong>Scientific:</strong> ${card.scientific}</div>
          <div id="answer" style="margin: 15px; font-size: 1.2em;">???</div>
          <button onclick="showAnswer()">Show Answer</button>
        </div>
      `;
    }

    function showAnswer() {
      const card = deck[currentIndex];
      document.getElementById("answer").innerHTML = `<strong>${language.toUpperCase()}:</strong> ${card.common || "N/A"}`;
      document.getElementById("screen").innerHTML += `
        <button onclick="markKnown()">I knew</button>
        <button onclick="markFailed()">I failed!</button>
      `;
    }

    function markKnown() {
      deck.splice(currentIndex, 1);
      if (currentIndex >= deck.length) currentIndex = 0;
      showCard();
    }

    function markFailed() {
      failedCards.push(deck[currentIndex]);
      deck.push(deck[currentIndex]);
      deck.splice(currentIndex, 1);
      if (currentIndex >= deck.length) currentIndex = 0;
      showCard();
    }

    function showSummary() {
      const list = failedCards.map(c => `<li>${c.scientific} (${c.common || "N/A"})</li>`).join("");
      document.getElementById("screen").innerHTML = `
        <h2>Resumen</h2>
        <p>Fallaste ${failedCards.length} especies:</p>
        <ul>${list}</ul>
        <button onclick="exportDeck()">Exportar falladas</button>
        <button onclick="showStartScreen()">Volver al inicio</button>
      `;
    }

    function exportDeck() {
      const blob = new Blob([JSON.stringify(failedCards)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "failed_cards.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importDeck() {
      const fileInput = document.getElementById("importFile");
      fileInput.click();
      fileInput.onchange = async () => {
        const file = fileInput.files[0];
        const text = await file.text();
        failedCards = JSON.parse(text);
        deck = [...failedCards];
        currentIndex = 0;
        showCard();
      };
    }

    // inicio
    showStartScreen();
  </script>
</body>
</html>